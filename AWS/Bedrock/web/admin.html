<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Admin RAG - Gestione Memoria IA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
    <h1 class="mb-4">üõ†Ô∏è Admin RAG - Gestione Memoria IA</h1>
    <div id="alert" style="display:none"></div>
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <strong>üìÇ Elenco File Conosciuti dall'IA</strong>
        </div>
        <div class="card-body p-0">
            <table class="table table-striped mb-0" id="filesTable">
                <thead>
                    <tr>
                        <th>Nome File</th>
                        <th>Tipo</th>
                        <th>Numero Chunk</th>
                        <th>Forget</th>
                    </tr>
                </thead>
                <tbody id="filesBody">
                    <!-- Popolato da JS -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-secondary text-white">
            <strong>üß† Tutto ci√≤ che l'IA ha imparato (chunk/documenti)</strong>
        </div>
        <div class="card-body" style="max-height:400px; overflow:auto;">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th>Nome File</th>
                        <th>Tipo</th>
                        <th>Chunk</th>
                        <th>Testo Appreso</th>
                    </tr>
                </thead>
                <tbody id="chunksBody">
                    <!-- Popolato da JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
//const BASE_URL = location.origin.replace(/:\d+$/, ':8000'); // Adatta se serve
const BASE_URL = location.protocol + '//' + location.hostname + ':8000';
// Carica dati da /chroma/all
async function loadChroma() {
    const res = await fetch(BASE_URL + "/chroma/all");
    const data = await res.json();

    // Raggruppa per file
    const fileMap = {};
    (data.metadatas || []).forEach(meta => {
        if (!fileMap[meta.name]) fileMap[meta.name] = {type: meta.content_type, count: 0};
        fileMap[meta.name].count++;
    });

    // Popola tabella file
    const filesBody = document.getElementById('filesBody');
    filesBody.innerHTML = '';
    Object.entries(fileMap).forEach(([name, info]) => {
        filesBody.innerHTML += `
            <tr>
                <td>${name}</td>
                <td>${info.type}</td>
                <td>${info.count}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="forgetFile('${encodeURIComponent(name)}', this)">Forget</button>
                </td>
            </tr>
        `;
    });

    // Popola tabella chunk
    const chunksBody = document.getElementById('chunksBody');
    chunksBody.innerHTML = '';
    (data.metadatas || []).forEach((meta, i) => {
        const doc = (data.documents && data.documents[i]) ? data.documents[i] : '';
        chunksBody.innerHTML += `
            <tr>
                <td>${meta.name}</td>
                <td>${meta.content_type}</td>
                <td>${meta.chunk}</td>
                <td style="max-width:350px; white-space:pre-wrap;">${doc.length > 300 ? doc.slice(0,300) + '‚Ä¶' : doc}</td>
            </tr>
        `;
    });
}

// Forget file
async function forgetFile(filename, btn) {
    if (!confirm("Vuoi davvero far dimenticare all'IA il file '" + decodeURIComponent(filename) + "'?")) return;
    btn.disabled = true;
    btn.innerText = "Attendi...";
    const res = await fetch(BASE_URL + "/forget?filename=" + filename, {method: "DELETE"});
    const data = await res.json();
    showAlert(data.status === "ok" ? "success" : "danger", data.message || "File dimenticato con successo!");
    await loadChroma();
}

// Mostra alert bootstrap
function showAlert(type, msg) {
    const alert = document.getElementById('alert');
    alert.className = "alert alert-" + type + " mt-3";
    alert.innerText = msg;
    alert.style.display = "block";
    setTimeout(() => { alert.style.display = "none"; }, 4000);
}

// Carica dati all'avvio
loadChroma();
</script>
</body>
</html>